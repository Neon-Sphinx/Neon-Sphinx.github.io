<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chiikawaç¾é£Ÿå®¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Face-API.js -->
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            overflow: hidden;
            background-color: #FFF5F7;
            user-select: none;
        }
        
        /* æ¸¸æˆç”»å¸ƒå±‚çº§ç®¡ç† */
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #webcam, #canvas-output {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* ä»…ç¿»è½¬éšè—çš„webcamä½œä¸ºå‚è€ƒï¼ŒCanvasç”±JSå†…éƒ¨ç»˜åˆ¶ç¿»è½¬ï¼ŒCSSä¸éœ€è¦å†ç¿»è½¬ */
        #webcam {
            transform: scaleX(-1);
        }

        /* ä¿®å¤UIå±‚ä¸è¢«é•œåƒå½±å“ */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€åˆ°ä¸‹é¢å¦‚æœéœ€è¦ï¼Œä½†è¿™é‡ŒæŒ‰é’®æœ‰ pointer-events-auto */
        }

        .pointer-auto {
            pointer-events: auto;
        }

        /* åŠ¨ç”»ç±» */
        .wiggle { animation: wiggle 2s linear infinite; }
        @keyframes wiggle {
            0%, 7% { transform: rotateZ(0); }
            15% { transform: rotateZ(-5deg); }
            20% { transform: rotateZ(3deg); }
            25% { transform: rotateZ(-5deg); }
            30% { transform: rotateZ(2deg); }
            35%, 100% { transform: rotateZ(0); }
        }

        .pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }

        .float { animation: float 3s ease-in-out infinite; }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        /* è‡ªå®šä¹‰è¿›åº¦æ¡ */
        .patience-bar-container {
            transition: width 0.1s linear;
        }

        /* è§’è‰²æ°”æ³¡ */
        .bubble {
            position: relative;
            background: #fff;
            border-radius: .4em;
        }
        .bubble:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-top-color: #fff;
            border-bottom: 0;
            margin-left: -10px;
            margin-bottom: -10px;
        }
    </style>
</head>
<body>

    <div id="game-container">
        <!-- è§†é¢‘å±‚ (éšè—åŸå§‹è§†é¢‘ï¼Œç”¨Canvasç»˜åˆ¶ä»¥ä¿æŒåŒæ­¥) -->
        <video id="webcam" autoplay muted playsinline class="hidden"></video>
        
        <!-- æ¸¸æˆæ¸²æŸ“å±‚ -->
        <canvas id="canvas-output"></canvas>

        <!-- UI å±‚ -->
        <div id="ui-layer" class="flex flex-col justify-between p-4">
            
            <!-- é¡¶éƒ¨ HUD -->
            <div id="hud" class="hidden flex justify-between items-start w-full">
                <!-- å·¦ä¸Šï¼šè½®æ¬¡ -->
                <div class="bg-white/80 backdrop-blur-sm rounded-xl p-3 shadow-lg border-2 border-pink-300">
                    <p class="text-xs text-pink-500 font-bold uppercase">ROUND</p>
                    <p id="round-display" class="text-3xl font-black text-pink-600">1/5</p>
                </div>

                <!-- ä¸­é—´ï¼šæ¸¸æˆå€’è®¡æ—¶ -->
                <div class="flex flex-col items-center">
                    <div class="relative">
                        <svg class="w-20 h-20 transform -rotate-90">
                            <circle cx="40" cy="40" r="36" stroke="#fce7f3" stroke-width="8" fill="none"/>
                            <circle id="timer-circle" cx="40" cy="40" r="36" stroke="#ec4899" stroke-width="8" fill="none" stroke-dasharray="226" stroke-dashoffset="0" class="transition-all duration-1000 ease-linear"/>
                        </svg>
                        <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center">
                            <span id="game-timer" class="text-2xl font-black text-pink-600">60</span>
                        </div>
                    </div>
                    <p id="timer-warning" class="text-red-500 font-bold text-sm mt-1 opacity-0 transition-opacity">å¿«ç‚¹åƒï¼</p>
                </div>

                <!-- å³ä¸Šï¼šåˆ†æ•° -->
                <div class="bg-white/80 backdrop-blur-sm rounded-xl p-3 shadow-lg border-2 border-yellow-300">
                    <p class="text-xs text-yellow-600 font-bold uppercase">SCORE</p>
                    <p id="score-display" class="text-3xl font-black text-yellow-500">0</p>
                </div>
            </div>

            <!-- å·¦ä¾§ï¼šè§’è‰²ä»»åŠ¡ -->
            <div id="character-panel" class="hidden absolute top-32 left-4 w-48 pointer-events-none transition-all duration-300 transform -translate-x-full">
                <!-- æ°”æ³¡ -->
                <div class="bubble bg-white p-3 rounded-2xl shadow-xl border-2 border-blue-200 mb-4 animate-bounce">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-bold text-gray-600">æƒ³åƒ:</span>
                        <span id="target-food-icon" class="text-3xl">ğŸ£</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div id="patience-bar" class="bg-green-500 h-2.5 rounded-full" style="width: 100%"></div>
                    </div>
                </div>
                
                <!-- è§’è‰²å¤´åƒ -->
                <div id="character-avatar" class="text-6xl filter drop-shadow-lg transition-transform transform scale-110">
                    ğŸ±
                </div>
                <p id="character-name" class="mt-2 text-white font-bold text-shadow-md bg-black/30 px-2 rounded w-max">å°å…«</p>
            </div>

            <!-- ä¸­å¿ƒï¼šé€šçŸ¥ä¸è¦†ç›–å±‚ -->
            
            <!-- åŠ è½½é¡µ -->
            <div id="loading-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-pink-50 z-50 pointer-auto">
                <div class="text-6xl mb-4 animate-spin">ğŸ¥</div>
                <h1 class="text-2xl font-bold text-pink-600 mb-2">æ­£åœ¨å‡†å¤‡é£Ÿæ...</h1>
                <p class="text-gray-500 text-sm">æ­£åœ¨åŠ è½½ AI æ¨¡å‹ï¼Œè¯·ç¨å€™ (é¦–æ¬¡å¯èƒ½è¾ƒæ…¢)</p>
                <p id="loading-progress" class="text-pink-400 font-mono mt-2">0%</p>
            </div>

            <!-- ä»‹ç»é¡µ -->
            <div id="intro-screen" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-gradient-to-br from-pink-100 to-blue-100 z-40 pointer-auto">
                <h1 class="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-600 mb-6 drop-shadow-sm font-['Fredoka_One']">Chiikawa<br>ç¾é£Ÿå®¶</h1>
                <div class="flex gap-4 mb-8 text-6xl">
                    <div class="float" style="animation-delay: 0s;">ğŸ±</div>
                    <div class="float" style="animation-delay: 0.5s;">ğŸ°</div>
                    <div class="float" style="animation-delay: 1s;">ğŸ¹</div>
                </div>
                <div class="bg-white/90 p-6 rounded-2xl shadow-xl max-w-md text-center mb-8">
                    <p class="text-gray-700 mb-2 font-bold">å°å¯çˆ±ä»¬æ­£åœ¨å¯»æ‰¾ä¼ è¯´ä¸­çš„ç¾é£Ÿå®¶ï¼</p>
                    <ul class="text-left text-sm text-gray-600 space-y-2 list-disc pl-5">
                        <li>å…è®¸æ‘„åƒå¤´æƒé™ï¼Œå¼ å¼€å˜´å·´æ¥åƒæ‰é£Ÿç‰©ã€‚</li>
                        <li>æ ¹æ®å·¦ä¾§å°å¯çˆ±çš„è¦æ±‚åƒå¯¹åº”çš„é£Ÿç‰©ã€‚</li>
                        <li>å…±æœ‰5è½®ï¼Œé£Ÿç‰©è¿åŠ¨æ–¹å¼ä¼šè¶Šæ¥è¶Šéš¾ï¼</li>
                        <li>å¦‚æœä½ åœ¨10ç§’å†…æ²¡åƒåˆ°ï¼Œå°å¯çˆ±ä¼šç”Ÿæ°”çš„ï¼</li>
                    </ul>
                </div>
                <button id="start-game-btn" class="bg-pink-500 hover:bg-pink-600 text-white text-xl font-bold py-4 px-12 rounded-full shadow-lg transform transition hover:scale-105 active:scale-95">
                    å¼€å§‹æŒ‘æˆ˜
                </button>
            </div>

            <!-- è½®æ¬¡å¼€å§‹è¦†ç›–å±‚ -->
            <div id="round-start-screen" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-black/60 z-30 pointer-auto backdrop-blur-sm">
                <h2 id="round-title" class="text-4xl text-white font-bold mb-2">ç¬¬ 1 è½®</h2>
                <p id="round-desc" class="text-xl text-yellow-300 mb-6">ç®€å•çš„é™æ­¢é£Ÿç‰©</p>
                <button id="start-round-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg">
                    å‡†å¤‡å¥½äº†ï¼
                </button>
            </div>

            <!-- ç»“ç®—/ç»“æŸé¡µ -->
            <div id="end-screen" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-white/95 z-50 pointer-auto">
                <h2 id="end-title" class="text-5xl font-bold text-pink-600 mb-4">You Win!!!</h2>
                <div id="star-container" class="flex gap-2 text-6xl mb-6 text-gray-300">
                    <span>â˜…</span><span>â˜…</span><span>â˜…</span>
                </div>
                <p id="rank-title" class="text-2xl font-bold text-gray-800 mb-8">è·å¾—ç§°å·ï¼šåˆçº§åƒè´§</p>
                <div class="flex gap-8 mb-8">
                     <div class="text-center"><div class="text-4xl wiggle">ğŸ±</div><div class="text-xs mt-1">å°å…«</div></div>
                     <div class="text-center"><div class="text-4xl wiggle" style="animation-delay: 0.2s">ğŸ°</div><div class="text-xs mt-1">ä¹Œè¨å¥‡</div></div>
                     <div class="text-center"><div class="text-4xl wiggle" style="animation-delay: 0.4s">ğŸ¹</div><div class="text-xs mt-1">å‰ä¼Š</div></div>
                </div>
                <button id="restart-game-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg">
                    é‡æ–°å¼€å§‹
                </button>
            </div>
            
            <!-- è§†è§‰åé¦ˆï¼šåƒåˆ°ä¸œè¥¿æˆ–é”™è¯¯ -->
            <div id="feedback-overlay" class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-6xl font-black text-white drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)] z-20 pointer-events-none">
                YUMMY!
            </div>
        </div>
    </div>

    <script>
        // --- æ¸¸æˆé…ç½®ä¸çŠ¶æ€ ---
        const CONF = {
            patienceMax: 10, // å•ä¸ªè§’è‰²è€å¿ƒç§’æ•°
            roundTime: 60,   // æ¯è½®ç§’æ•°
            mouthThreshold: 15, // å˜´å·´å¼ å¼€åˆ¤å®šé˜ˆå€¼ (åƒç´ ï¼Œæ ¹æ®è·ç¦»ç¼©æ”¾)
            spawnRate: 60, // å¸§æ•°é—´éš”
        };

        const CHARACTERS = [
            { name: "å°å…«", icon: "ğŸ±", color: "text-blue-500", foods: ["ğŸ£", "ğŸœ", "ğŸ™", "ğŸŸ"] },
            { name: "ä¹Œè¨å¥‡", icon: "ğŸ°", color: "text-yellow-500", foods: ["ğŸ®", "ğŸ¡", "ğŸŒ½", "ğŸŒ­"] },
            { name: "å‰ä¼Š", icon: "ğŸ¹", color: "text-pink-500", foods: ["ğŸˆ", "ğŸ“", "ğŸ°", "ğŸ­"] }
        ];

        const ALL_FOODS = ["ğŸ£", "ğŸœ", "ğŸ™", "ğŸŸ", "ğŸ®", "ğŸ¡", "ğŸŒ½", "ğŸŒ­", "ğŸˆ", "ğŸ“", "ğŸ°", "ğŸ­", "ğŸ”", "ğŸ•", "ğŸŸ"];

        let state = {
            screen: 'loading', // loading, intro, playing, roundWait, end
            round: 1,
            score: 0,
            roundTimer: 60,
            patienceTimer: 10,
            currentCharIdx: 0,
            targetFood: "",
            foods: [], // å½“å‰å±å¹•ä¸Šçš„é£Ÿç‰©å¯¹è±¡
            stars: 0,
            isMouthOpen: false,
            mouthPos: { x: 0, y: 0 },
            lastTime: 0
        };

        // --- DOM å…ƒç´  ---
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('canvas-output');
        const ctx = canvas.getContext('2d');
        const loadingScreen = document.getElementById('loading-screen');
        const introScreen = document.getElementById('intro-screen');
        const roundStartScreen = document.getElementById('round-start-screen');
        const endScreen = document.getElementById('end-screen');
        const hud = document.getElementById('hud');
        const charPanel = document.getElementById('character-panel');
        const feedback = document.getElementById('feedback-overlay');

        // --- åˆå§‹åŒ– Face API ---
        async function init() {
            try {
                // åŠ è½½è½»é‡çº§æ¨¡å‹
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/'; 
                
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                document.getElementById('loading-progress').innerText = "30%";
                await faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_URL);
                document.getElementById('loading-progress').innerText = "60%";

                startVideo();
            } catch (e) {
                console.error(e);
                alert("æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ·æ–°é‡è¯•ã€‚");
            }
        }

        function startVideo() {
            navigator.mediaDevices.getUserMedia({ video: {} })
                .then(stream => {
                    video.srcObject = stream;
                    // æ˜¾å¼è°ƒç”¨ play() ä»¥ç¡®ä¿è§†é¢‘æµå¼€å§‹æ’­æ”¾ï¼Œå¦åˆ™ canvas ç»˜åˆ¶çš„ç”»é¢ä¼šæ˜¯é™æ­¢çš„
                    video.play().then(() => {
                        document.getElementById('loading-progress').innerText = "100%";
                        setTimeout(() => {
                            loadingScreen.classList.add('hidden');
                            introScreen.classList.remove('hidden');
                        }, 500);
                    }).catch(err => {
                         console.error("è§†é¢‘æ’­æ”¾å¤±è´¥:", err);
                    });
                })
                .catch(err => {
                    console.error("æ— æ³•è·å–æ‘„åƒå¤´", err);
                    alert("è¯·å…è®¸æ‘„åƒå¤´æƒé™ä»¥è¿›è¡Œæ¸¸æˆã€‚å¦‚æœæ‚¨å·²å…è®¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚");
                });
        }

        // --- æ¸¸æˆé€»è¾‘æ ¸å¿ƒ ---

        // å¯åŠ¨æ¸¸æˆ
        document.getElementById('start-game-btn').addEventListener('click', () => {
            introScreen.classList.add('hidden');
            prepareRound(1);
        });

        document.getElementById('start-round-btn').addEventListener('click', () => {
            roundStartScreen.classList.add('hidden');
            startRound();
        });

        // é‡æ–°å¼€å§‹æ¸¸æˆé€»è¾‘
        document.getElementById('restart-game-btn').addEventListener('click', () => {
            endScreen.classList.add('hidden');
            // é‡ç½®çŠ¶æ€
            state.score = 0;
            state.round = 1;
            state.foods = [];
            state.stars = 0;
            document.getElementById('score-display').innerText = "0";
            // è¿”å›ä»‹ç»é¡µ
            introScreen.classList.remove('hidden');
        });

        function prepareRound(roundNum) {
            state.round = roundNum;
            state.screen = 'roundWait';
            hud.classList.add('hidden');
            charPanel.classList.add('hidden', '-translate-x-full');
            
            // è®¾ç½®è½®æ¬¡æè¿°
            const descriptions = [
                "é™æ­¢çš„ç¾å‘³",
                "å¤©ä¸Šæ‰é¦…é¥¼",
                "åé‡åŠ›ç¾é£Ÿ",
                "é«˜éš¾åº¦åƒæ’­",
                "ç–¯ç‹‚è‡ªåŠ©é¤"
            ];
            document.getElementById('round-title').innerText = `ç¬¬ ${roundNum} è½®`;
            document.getElementById('round-display').innerText = `${roundNum}/5`;
            document.getElementById('round-desc').innerText = descriptions[roundNum - 1];
            
            roundStartScreen.classList.remove('hidden');
        }

        function startRound() {
            state.screen = 'playing';
            state.roundTimer = CONF.roundTime;
            state.foods = [];
            state.lastTime = Date.now();
            
            hud.classList.remove('hidden');
            charPanel.classList.remove('hidden');
            // ç¨å¾®å»¶è¿Ÿè®©UIæ»‘å…¥
            setTimeout(() => charPanel.classList.remove('-translate-x-full'), 100);

            nextCharacterTask();
            gameLoop();
        }

        function nextCharacterTask() {
            // éšæœºé€‰ä¸€ä¸ªè§’è‰²
            state.currentCharIdx = Math.floor(Math.random() * CHARACTERS.length);
            const char = CHARACTERS[state.currentCharIdx];
            
            // éšæœºé€‰è¯¥è§’è‰²å–œæ¬¢çš„ä¸€ä¸ªé£Ÿç‰©
            state.targetFood = char.foods[Math.floor(Math.random() * char.foods.length)];
            state.patienceTimer = CONF.patienceMax;

            // æ›´æ–°UI
            document.getElementById('character-avatar').innerText = char.icon;
            const nameEl = document.getElementById('character-name');
            nameEl.innerText = char.name;
            nameEl.className = `mt-2 text-white font-bold text-shadow-md bg-black/30 px-2 rounded w-max ${char.color.replace('text', 'bg').replace('500', '400')}`;
            
            document.getElementById('target-food-icon').innerText = state.targetFood;
            updatePatienceBar();
        }

        function updatePatienceBar() {
            const pct = (state.patienceTimer / CONF.patienceMax) * 100;
            const bar = document.getElementById('patience-bar');
            bar.style.width = `${pct}%`;
            
            if(pct < 30) bar.className = "h-2.5 rounded-full bg-red-500";
            else if(pct < 60) bar.className = "h-2.5 rounded-full bg-yellow-500";
            else bar.className = "h-2.5 rounded-full bg-green-500";
        }

        function spawnFood() {
            const isTarget = Math.random() < 0.4; // 40% æ¦‚ç‡ç”Ÿæˆå½“å‰ç›®æ ‡é£Ÿç‰©
            const type = isTarget ? state.targetFood : ALL_FOODS[Math.floor(Math.random() * ALL_FOODS.length)];
            
            const w = canvas.width;
            const h = canvas.height;
            const size = 50;

            let food = {
                x: Math.random() * (w - size),
                y: Math.random() * (h - size),
                size: size,
                type: type,
                vx: 0,
                vy: 0,
                gravity: 0,
                life: 300 // 5ç§’åæ¶ˆå¤±
            };

            // æ ¹æ®è½®æ¬¡è®¾ç½®ç‰©ç†å±æ€§
            switch (state.round) {
                case 1: // é™æ­¢
                    // éšæœºä½ç½®ï¼Œä¸åŠ¨
                    break;
                case 2: // ä¸‹è½
                    food.y = -50;
                    food.vy = 2 + Math.random() * 2;
                    break;
                case 3: // ä¸Šå‡
                    food.y = h + 50;
                    food.vy = -(2 + Math.random() * 2);
                    break;
                case 4: // æŠ›ç‰©çº¿
                    food.y = h / 2 + Math.random() * 100;
                    if (Math.random() > 0.5) {
                        food.x = -50;
                        food.vx = 4 + Math.random() * 2;
                    } else {
                        food.x = w + 50;
                        food.vx = -(4 + Math.random() * 2);
                    }
                    food.vy = -8 - Math.random() * 4;
                    food.gravity = 0.2;
                    break;
                case 5: // éšæœº
                    food.vx = (Math.random() - 0.5) * 6;
                    food.vy = (Math.random() - 0.5) * 6;
                    break;
            }

            state.foods.push(food);
        }

        function updatePhysics() {
            const w = canvas.width;
            const h = canvas.height;

            // æ›´æ–°é£Ÿç‰©ä½ç½®
            for (let i = state.foods.length - 1; i >= 0; i--) {
                let f = state.foods[i];
                
                f.x += f.vx;
                f.y += f.vy;
                f.vy += f.gravity;

                // è¾¹ç•Œå¤„ç†
                if (state.round === 5) {
                    if (f.x < 0 || f.x > w) f.vx *= -1;
                    if (f.y < 0 || f.y > h) f.vy *= -1;
                }

                // ç§»é™¤å‡ºç•Œæˆ–è¶…æ—¶çš„é£Ÿç‰©
                f.life--;
                if (f.life <= 0 || (state.round !== 1 && (f.y > h + 100 || f.y < -100 || f.x < -100 || f.x > w + 100))) {
                    state.foods.splice(i, 1);
                }
            }

            // è¡¥å……é£Ÿç‰©
            if (state.foods.length < 5 && Math.random() < 0.05) {
                spawnFood();
            }
        }

        function checkCollisions() {
            if (!state.isMouthOpen) return;

            // å˜´å·´åˆ¤å®šåŒºåŸŸ (å‡è®¾å˜´å·´ä¸­å¿ƒå‘¨å›´ 40px)
            const mouthRect = {
                x: state.mouthPos.x - 30,
                y: state.mouthPos.y - 30,
                w: 60,
                h: 60
            };

            for (let i = state.foods.length - 1; i >= 0; i--) {
                let f = state.foods[i];
                
                // ç®€å•çš„çŸ©å½¢ç¢°æ’
                if (mouthRect.x < f.x + f.size &&
                    mouthRect.x + mouthRect.w > f.x &&
                    mouthRect.y < f.y + f.size &&
                    mouthRect.y + mouthRect.h > f.y) {
                    
                    // åƒåˆ°é£Ÿç‰©
                    handleEat(f.type);
                    state.foods.splice(i, 1);
                    break; // ä¸€æ¬¡åªåƒä¸€ä¸ª
                }
            }
        }

        function handleEat(foodType) {
            if (foodType === state.targetFood) {
                // åƒå¯¹äº†
                const points = Math.floor(100 * (state.patienceTimer / 10)) + 10;
                state.score += points;
                document.getElementById('score-display').innerText = state.score;
                
                showFeedback(`+${points}`, "text-green-400");
                nextCharacterTask();
            } else {
                // åƒé”™äº†
                showFeedback("å‘ƒ...", "text-gray-400");
                // ä¸æ‰£åˆ†ï¼Œä½†ä¹Ÿä¸åŠ åˆ†ï¼Œä¸”ä¸åˆ‡æ¢ä»»åŠ¡
            }
        }

        function showFeedback(text, colorClass) {
            feedback.innerText = text;
            feedback.className = `absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-6xl font-black drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)] z-20 pop-in ${colorClass}`;
            feedback.classList.remove('hidden');
            setTimeout(() => {
                feedback.classList.add('hidden');
            }, 800);
        }

        function gameEnd() {
            state.screen = 'end';
            hud.classList.add('hidden');
            charPanel.classList.add('hidden', '-translate-x-full');

            // è®¡ç®—æ˜Ÿæ˜Ÿ (å‡è®¾æ¯è½®å¹³å‡1000åˆ†ç®—æ»¡åˆ†ï¼Œ5è½®5000)
            // ç®€å•åŒ–ï¼šæ¯1000åˆ†ä¸€é¢—æ˜Ÿï¼Œæœ€å°‘1ï¼Œæœ€å¤š3
            // ä¿®æ­£é€»è¾‘ï¼šç´¯è®¡5è½®æ€»åˆ†ã€‚
            // å‡è®¾ä¸€è½®èƒ½åƒ5-6ä¸ªï¼Œæ¯ä¸ªå¹³å‡50åˆ†ï¼Œä¸€è½®300åˆ†ã€‚5è½®1500åˆ†ã€‚
            let stars = 0;
            if (state.score < 500) stars = 1;
            else if (state.score < 1500) stars = 2;
            else stars = 3;

            // æ¸²æŸ“ç»“æŸé¡µ
            const starContainer = document.getElementById('star-container');
            starContainer.innerHTML = '';
            for(let i=0; i<3; i++) {
                const s = document.createElement('span');
                s.innerText = i < stars ? 'â˜…' : 'â˜†';
                s.className = i < stars ? 'text-yellow-400' : 'text-gray-300';
                starContainer.appendChild(s);
            }

            const titles = ["ç¾é£Ÿæ¢ç´¢è€…", "èµ„æ·±åƒè´§", "ä¼ è¯´çº§ç¾é£Ÿå®¶"];
            document.getElementById('rank-title').innerText = `è·å¾—ç§°å·ï¼š${titles[stars-1]}`;
            endScreen.classList.remove('hidden');
        }

        async function gameLoop() {
            if (state.screen !== 'playing') return;

            const now = Date.now();
            const dt = (now - state.lastTime) / 1000;
            state.lastTime = now;

            // 1. æ—¶é—´ç®¡ç†
            state.roundTimer -= dt;
            state.patienceTimer -= dt;

            // æ›´æ–°åœ†å½¢å€’è®¡æ—¶UI
            const dashOffset = 226 * (1 - state.roundTimer / CONF.roundTime);
            document.getElementById('timer-circle').style.strokeDashoffset = dashOffset;
            document.getElementById('game-timer').innerText = Math.ceil(state.roundTimer);

            // 10ç§’è­¦å‘Š
            if(state.roundTimer <= 10) {
                document.getElementById('timer-warning').style.opacity = (Math.floor(now / 500) % 2); // é—ªçƒ
            } else {
                document.getElementById('timer-warning').style.opacity = 0;
            }

            // è€å¿ƒè€—å°½
            if (state.patienceTimer <= 0) {
                state.score = Math.max(0, state.score - 50); // æ‰£åˆ†
                document.getElementById('score-display').innerText = state.score;
                showFeedback("ç”Ÿæ°”äº†!", "text-red-500");
                nextCharacterTask();
            }
            updatePatienceBar();

            // è½®æ¬¡ç»“æŸ
            if (state.roundTimer <= 0) {
                if (state.round < 5) {
                    prepareRound(state.round + 1);
                } else {
                    gameEnd();
                }
                return;
            }

            // 2. æ£€æµ‹äººè„¸
            // è®¾ç½®canvaså°ºå¯¸åŒ¹é…video
            const displaySize = { width: video.videoWidth, height: video.videoHeight };
            if (canvas.width !== displaySize.width) {
                faceapi.matchDimensions(canvas, displaySize);
            }

            // ä½¿ç”¨ TinyFaceDetector å’Œ Landmarks
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks(true);
            const resizedDetections = faceapi.resizeResults(detections, displaySize);

            // æ¸…ç©ºå¹¶ç»˜åˆ¶è§†é¢‘å¸§åˆ° Canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // é•œåƒç»˜åˆ¶è§†é¢‘
            ctx.save();
            ctx.scale(-1, 1);
            ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
            ctx.restore();

            // 3. å¤„ç†äººè„¸é€»è¾‘
            state.isMouthOpen = false;
            if (resizedDetections.length > 0) {
                const landmarks = resizedDetections[0].landmarks;
                const mouth = landmarks.getMouth();
                
                // å˜´å·´ç‚¹ä½ï¼š62 (ä¸Šå”‡ä¸‹æ²¿) - 66 (ä¸‹å”‡ä¸Šæ²¿) åœ¨68ç‚¹æ¨¡å‹ä¸­ã€‚
                // åœ¨ face-api tiny model ä¸­ï¼Œå˜´å·´ç‚¹ä½ç´¢å¼•ä¸åŒã€‚
                // ä¸ºäº†é€šç”¨ï¼Œæˆ‘ä»¬è®¡ç®—å˜´å·´å¤–è½®å»“çš„é«˜åº¦ã€‚
                // getMouth() è¿”å›20ä¸ªç‚¹ã€‚
                // ç®€å•èµ·è§ï¼Œå–å˜´å·´æœ€é«˜ç‚¹å’Œæœ€ä½ç‚¹çš„è·ç¦»ã€‚
                const topLip = mouth[14]; // å†…éƒ¨ä¸Š
                const bottomLip = mouth[18]; // å†…éƒ¨ä¸‹
                const mouthHeight = Math.abs(bottomLip.y - topLip.y);
                
                // è·å–è„¸éƒ¨å¤§å°ä½œä¸ºå‚è€ƒï¼Œå½’ä¸€åŒ–é˜ˆå€¼
                const faceBox = resizedDetections[0].detection.box;
                const faceHeight = faceBox.height;
                
                // é˜ˆå€¼ï¼šå˜´å·´å¼€åˆåº¦ / è„¸é«˜ > 0.05
                if (mouthHeight / faceHeight > 0.05) {
                    state.isMouthOpen = true;
                }

                // å˜´å·´ä¸­å¿ƒ
                // é•œåƒåæ ‡å¤„ç†ï¼šå› ä¸ºæˆ‘ä»¬åœ¨CSSä¸­åè½¬äº†Canvasï¼Œä½†åœ¨JSé€»è¾‘ä¸­åæ ‡æ˜¯åŸå§‹çš„ã€‚
                // ç»˜åˆ¶é€»è¾‘ä¹Ÿåšäº†ç¿»è½¬ã€‚ä½†æ˜¯ Food çš„é€»è¾‘æ˜¯åŸºäº Canvas å®½åº¦çš„ (0-width)ã€‚
                // æ£€æµ‹åˆ°çš„ x æ˜¯åŸºäºåŸå§‹è§†é¢‘çš„ã€‚
                // å‡è®¾è§†é¢‘å®½640ï¼Œäººè„¸åœ¨100ã€‚é•œåƒåäººè„¸åº”è¯¥åœ¨ 640-100 = 540ã€‚
                const rawX = (topLip.x + bottomLip.x) / 2;
                const rawY = (topLip.y + bottomLip.y) / 2;
                
                // è½¬æ¢ä¸ºé•œåƒåæ ‡ç”¨äºæ¸¸æˆé€»è¾‘ç¢°æ’
                state.mouthPos.x = canvas.width - rawX; 
                state.mouthPos.y = rawY;

                // è°ƒè¯•ï¼šç»˜åˆ¶å˜´å·´ä½ç½®
                ctx.beginPath();
                ctx.arc(state.mouthPos.x, state.mouthPos.y, state.isMouthOpen ? 30 : 10, 0, 2 * Math.PI);
                ctx.fillStyle = state.isMouthOpen ? "rgba(255, 0, 0, 0.5)" : "rgba(255, 255, 255, 0.5)";
                ctx.fill();
                if(state.isMouthOpen) {
                    ctx.fillStyle = "white";
                    ctx.font = "20px Arial";
                    ctx.fillText("å•Š~", state.mouthPos.x - 15, state.mouthPos.y - 40);
                }
            }

            // 4. æ›´æ–°ä¸ç»˜åˆ¶é£Ÿç‰©
            updatePhysics();
            
            ctx.font = "50px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            
            state.foods.forEach(f => {
                ctx.fillText(f.type, f.x + f.size/2, f.y + f.size/2);
            });

            // 5. ç¢°æ’æ£€æµ‹
            checkCollisions();

            requestAnimationFrame(gameLoop);
        }

        // åˆå§‹åŒ–
        window.onload = init;

    </script>
</body>
</html>